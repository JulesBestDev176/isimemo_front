import { jsx as _jsx, jsxs as _jsxs, Fragment as _Fragment } from "react/jsx-runtime";
import { useState } from 'react';
import { motion, AnimatePresence } from 'framer-motion';
import { X, Eye, Download, CheckCircle, XCircle, FileText, User, ShieldAlert, Loader2 } from 'lucide-react';
import { Button } from '../ui/button';
import { Badge } from '../ui/badge';
import { StatutDemandePrelecture } from '../../models/dossier/DemandePrelecture';
import { detectSimilarDocuments, getSimilarityRiskLevel, getSimilarityRiskColor } from '../../models/dossier/SimilarDocument';
export const PrelectureDetail = ({ demande, onClose, onValider, onRejeter }) => {
    var _a, _b, _c, _d, _e, _f;
    const [commentaire, setCommentaire] = useState('');
    const [rejetCommentaire, setRejetCommentaire] = useState('');
    const [corrections, setCorrections] = useState(['']);
    const [showRejetModal, setShowRejetModal] = useState(false);
    const [showValidationModal, setShowValidationModal] = useState(false);
    // États pour la vérification de plagiat
    const [plagiarismVerified, setPlagiarismVerified] = useState(false);
    const [isCheckingPlagiarism, setIsCheckingPlagiarism] = useState(false);
    const [similarDocuments, setSimilarDocuments] = useState([]);
    const [selectedDocument, setSelectedDocument] = useState(null);
    const formatDate = (date) => {
        return date.toLocaleDateString('fr-FR', {
            day: 'numeric',
            month: 'long',
            year: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
        });
    };
    const handleAddCorrection = () => {
        setCorrections([...corrections, '']);
    };
    const handleRemoveCorrection = (index) => {
        setCorrections(corrections.filter((_, i) => i !== index));
    };
    const handleCorrectionChange = (index, value) => {
        const newCorrections = [...corrections];
        newCorrections[index] = value;
        setCorrections(newCorrections);
    };
    const handleConfirmValidation = () => {
        onValider(demande.idDemandePrelecture, commentaire.trim() || undefined);
        setShowValidationModal(false);
        setCommentaire('');
        onClose();
    };
    const handleConfirmRejet = () => {
        if (!rejetCommentaire.trim()) {
            alert('Veuillez fournir un commentaire de rejet.');
            return;
        }
        const correctionsFiltrees = corrections.filter(c => c.trim() !== '');
        onRejeter(demande.idDemandePrelecture, rejetCommentaire, correctionsFiltrees);
        setShowRejetModal(false);
        setRejetCommentaire('');
        setCorrections(['']);
        onClose();
    };
    // Handler pour vérifier le plagiat
    const handleCheckPlagiarism = () => {
        setIsCheckingPlagiarism(true);
        // Simulation de la vérification (2 secondes)
        setTimeout(() => {
            const similar = detectSimilarDocuments(demande.dossierMemoire.idDossierMemoire);
            setSimilarDocuments(similar);
            setPlagiarismVerified(true);
            setIsCheckingPlagiarism(false);
        }, 2000);
    };
    const canValider = demande.statut === StatutDemandePrelecture.EN_ATTENTE ||
        demande.statut === StatutDemandePrelecture.EN_COURS;
    const canRejeter = demande.statut === StatutDemandePrelecture.EN_ATTENTE ||
        demande.statut === StatutDemandePrelecture.EN_COURS;
    return (_jsxs(_Fragment, { children: [_jsx(AnimatePresence, { children: _jsx(motion.div, { initial: { opacity: 0 }, animate: { opacity: 1 }, exit: { opacity: 0 }, className: "fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4 overflow-y-auto", onClick: onClose, children: _jsxs(motion.div, { initial: { scale: 0.95, opacity: 0 }, animate: { scale: 1, opacity: 1 }, exit: { scale: 0.95, opacity: 0 }, onClick: (e) => e.stopPropagation(), className: "bg-white max-w-4xl w-full my-8", children: [_jsxs("div", { className: "border-b border-gray-200 px-6 py-4 flex justify-between items-center", children: [_jsx("h2", { className: "text-xl font-semibold text-gray-900", children: "D\u00E9tail de la pr\u00E9-lecture" }), _jsx("button", { onClick: onClose, className: "text-gray-400 hover:text-gray-600 transition-colors", children: _jsx(X, { className: "h-5 w-5" }) })] }), _jsxs("div", { className: "p-6 space-y-6 max-h-[calc(100vh-200px)] overflow-y-auto", children: [_jsxs("div", { className: "bg-gray-50 p-4", children: [_jsxs("h3", { className: "text-sm font-semibold text-gray-700 mb-3 flex items-center", children: [_jsx(User, { className: "h-4 w-4 mr-2" }), "Informations du candidat"] }), _jsxs("div", { className: "grid grid-cols-2 gap-4", children: [_jsxs("div", { children: [_jsx("p", { className: "text-sm text-gray-600", children: "Nom complet" }), _jsxs("p", { className: "text-sm font-medium text-gray-900", children: [(_a = demande.candidat) === null || _a === void 0 ? void 0 : _a.prenom, " ", (_b = demande.candidat) === null || _b === void 0 ? void 0 : _b.nom] })] }), _jsxs("div", { children: [_jsx("p", { className: "text-sm text-gray-600", children: "Email" }), _jsx("p", { className: "text-sm font-medium text-gray-900", children: (_c = demande.candidat) === null || _c === void 0 ? void 0 : _c.email })] }), _jsxs("div", { children: [_jsx("p", { className: "text-sm text-gray-600", children: "Matricule" }), _jsx("p", { className: "text-sm font-medium text-gray-900", children: (_d = demande.candidat) === null || _d === void 0 ? void 0 : _d.numeroMatricule })] })] })] }), _jsxs("div", { children: [_jsxs("h3", { className: "text-sm font-semibold text-gray-700 mb-3 flex items-center", children: [_jsx(FileText, { className: "h-4 w-4 mr-2" }), "Informations du m\u00E9moire"] }), _jsxs("div", { className: "space-y-3", children: [_jsxs("div", { children: [_jsx("p", { className: "text-sm text-gray-600", children: "Titre" }), _jsx("p", { className: "text-sm font-medium text-gray-900", children: demande.dossierMemoire.titre })] }), _jsxs("div", { children: [_jsx("p", { className: "text-sm text-gray-600", children: "Description" }), _jsx("p", { className: "text-sm text-gray-900", children: demande.dossierMemoire.description })] }), _jsxs("div", { className: "flex gap-4", children: [_jsxs("div", { children: [_jsx("p", { className: "text-sm text-gray-600", children: "Encadrant principal" }), _jsxs("p", { className: "text-sm font-medium text-gray-900", children: [(_e = demande.encadrantPrincipal) === null || _e === void 0 ? void 0 : _e.prenom, " ", (_f = demande.encadrantPrincipal) === null || _f === void 0 ? void 0 : _f.nom] })] }), _jsxs("div", { children: [_jsx("p", { className: "text-sm text-gray-600", children: "Date d'assignation" }), _jsx("p", { className: "text-sm font-medium text-gray-900", children: demande.dateAssignation ? formatDate(demande.dateAssignation) : '-' })] })] })] })] }), demande.documentMemoire && (_jsxs("div", { children: [_jsx("h3", { className: "text-sm font-semibold text-gray-700 mb-3", children: "Document du m\u00E9moire" }), _jsxs("div", { className: "bg-gray-50 p-4 flex items-center justify-between", children: [_jsxs("div", { className: "flex items-center gap-3", children: [_jsx(FileText, { className: "h-8 w-8 text-gray-400" }), _jsxs("div", { children: [_jsx("p", { className: "text-sm font-medium text-gray-900", children: demande.documentMemoire.nomFichier }), _jsx("p", { className: "text-xs text-gray-500", children: demande.documentMemoire.taille })] })] }), _jsxs("div", { className: "flex gap-2", children: [_jsxs(Button, { variant: "outline", size: "sm", onClick: () => window.open(demande.documentMemoire.cheminFichier, '_blank'), className: "flex items-center gap-2", children: [_jsx(Eye, { className: "h-4 w-4" }), "Visualiser"] }), _jsxs(Button, { variant: "outline", size: "sm", onClick: () => {
                                                                    // TODO: Implémenter le téléchargement
                                                                    console.log('Télécharger:', demande.documentMemoire.cheminFichier);
                                                                }, className: "flex items-center gap-2", children: [_jsx(Download, { className: "h-4 w-4" }), "T\u00E9l\u00E9charger"] })] })] })] })), _jsxs("div", { children: [_jsx("h3", { className: "text-sm font-semibold text-gray-700 mb-3", children: "Statut" }), demande.statut === StatutDemandePrelecture.EN_ATTENTE && (_jsx(Badge, { className: "bg-blue-50 text-blue-700 border-blue-200", children: "En attente" })), demande.statut === StatutDemandePrelecture.EN_COURS && (_jsx(Badge, { className: "bg-blue-50 text-blue-700 border-blue-200", children: "En cours" })), demande.statut === StatutDemandePrelecture.VALIDE && (_jsx(Badge, { className: "bg-blue-50 text-blue-700 border-blue-200", children: "Valid\u00E9" })), demande.statut === StatutDemandePrelecture.REJETE && (_jsx(Badge, { className: "bg-blue-50 text-blue-700 border-blue-200", children: "Rejet\u00E9" }))] }), demande.statut === StatutDemandePrelecture.VALIDE && demande.commentaire && (_jsxs("div", { className: "bg-blue-50 border border-blue-200 p-4", children: [_jsx("h3", { className: "text-sm font-semibold text-blue-900 mb-2", children: "Commentaire de validation" }), _jsx("p", { className: "text-sm text-blue-800", children: demande.commentaire })] })), demande.statut === StatutDemandePrelecture.REJETE && demande.feedbackRejet && (_jsxs("div", { className: "bg-blue-50 border border-blue-200 p-4", children: [_jsx("h3", { className: "text-sm font-semibold text-blue-900 mb-2", children: "Feedback de rejet" }), _jsx("p", { className: "text-sm text-blue-800 mb-3", children: demande.feedbackRejet.commentaire }), demande.feedbackRejet.corrections.length > 0 && (_jsxs("div", { children: [_jsx("p", { className: "text-sm font-semibold text-blue-900 mb-2", children: "Corrections \u00E0 apporter :" }), _jsx("ul", { className: "list-disc list-inside space-y-1", children: demande.feedbackRejet.corrections.map((correction, index) => (_jsx("li", { className: "text-sm text-blue-800", children: correction }, index))) })] }))] })), canValider && !plagiarismVerified && (_jsxs("div", { className: "pt-4 border-t border-gray-200", children: [_jsx("div", { className: "bg-blue-50 border border-blue-200 p-4 mb-4", children: _jsx("p", { className: "text-sm text-blue-800 mb-2", children: "Avant de valider ou rejeter cette pr\u00E9-lecture, veuillez v\u00E9rifier le plagiat pour d\u00E9tecter d'\u00E9ventuelles similitudes avec d'autres m\u00E9moires." }) }), _jsx(Button, { onClick: handleCheckPlagiarism, disabled: isCheckingPlagiarism, className: "flex items-center gap-2 bg-primary hover:bg-primary-700 w-full justify-center", children: isCheckingPlagiarism ? (_jsxs(_Fragment, { children: [_jsx(Loader2, { className: "h-4 w-4 animate-spin" }), "Analyse en cours..."] })) : (_jsxs(_Fragment, { children: [_jsx(ShieldAlert, { className: "h-4 w-4" }), "V\u00E9rifier le Plagiat"] })) })] })), plagiarismVerified && similarDocuments.length > 0 && (_jsxs("div", { className: "pt-4 border-t border-gray-200", children: [_jsxs("div", { className: "flex items-center justify-between mb-4", children: [_jsxs("h3", { className: "text-sm font-semibold text-gray-700", children: ["Documents Similaires D\u00E9tect\u00E9s (", similarDocuments.length, ")"] }), _jsxs(Badge, { className: "bg-blue-50 text-blue-700 border-blue-200", children: [_jsx(CheckCircle, { className: "h-3 w-3 mr-1" }), "V\u00E9rification effectu\u00E9e"] })] }), _jsx("div", { className: "space-y-3 mb-4", children: similarDocuments.map((doc) => {
                                                    const riskLevel = getSimilarityRiskLevel(doc.similarityScore);
                                                    const riskColor = getSimilarityRiskColor(doc.similarityScore);
                                                    return (_jsxs("div", { className: "bg-gray-50 border border-gray-200 p-4", children: [_jsxs("div", { className: "flex items-start justify-between mb-2", children: [_jsxs("div", { className: "flex-1", children: [_jsx("p", { className: "text-sm font-medium text-gray-900 mb-1", children: doc.titreMemoire }), _jsxs("p", { className: "text-xs text-gray-600", children: [doc.auteur.prenom, " ", doc.auteur.nom, " \u2022 ", doc.anneeAcademique] })] }), _jsxs(Badge, { className: riskColor, children: [doc.similarityScore, "% similarit\u00E9"] })] }), _jsxs("div", { className: "mb-3", children: [_jsx("div", { className: "flex items-center gap-2 mb-1", children: _jsx("span", { className: "text-xs text-gray-600", children: "Score de similarit\u00E9 :" }) }), _jsx("div", { className: "w-full bg-gray-200 h-2", children: _jsx("div", { className: "h-2 bg-blue-500", style: { width: `${doc.similarityScore}%` } }) })] }), doc.encadrant && (_jsxs("p", { className: "text-xs text-gray-600 mb-2", children: ["Encadrant : ", doc.encadrant.prenom, " ", doc.encadrant.nom] })), _jsxs(Button, { variant: "outline", size: "sm", onClick: () => setSelectedDocument(doc), className: "flex items-center gap-2", children: [_jsx(FileText, { className: "h-4 w-4" }), "Consulter le document"] })] }, doc.idDossier));
                                                }) })] })), plagiarismVerified && (canValider || canRejeter) ? (_jsxs("div", { className: "flex gap-3 pt-4 border-t border-gray-200", children: [canValider && (_jsxs(Button, { onClick: () => setShowValidationModal(true), className: "flex items-center gap-2 bg-primary hover:bg-primary-700", children: [_jsx(CheckCircle, { className: "h-4 w-4" }), "Valider"] })), canRejeter && (_jsxs(Button, { onClick: () => setShowRejetModal(true), variant: "outline", className: "flex items-center gap-2 border-gray-600 text-gray-700 hover:bg-gray-50", children: [_jsx(XCircle, { className: "h-4 w-4" }), "Rejeter"] }))] })) : null] })] }) }) }), showValidationModal && (_jsx(AnimatePresence, { children: _jsx(motion.div, { initial: { opacity: 0 }, animate: { opacity: 1 }, exit: { opacity: 0 }, className: "fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[60] p-4", onClick: () => setShowValidationModal(false), children: _jsxs(motion.div, { initial: { scale: 0.95, opacity: 0 }, animate: { scale: 1, opacity: 1 }, exit: { scale: 0.95, opacity: 0 }, onClick: (e) => e.stopPropagation(), className: "bg-white max-w-md w-full p-6", children: [_jsx("h3", { className: "text-lg font-semibold text-gray-900 mb-4", children: "Valider la pr\u00E9-lecture" }), _jsxs("div", { className: "mb-4", children: [_jsx("label", { className: "block text-sm font-medium text-gray-700 mb-1", children: "Commentaire (optionnel)" }), _jsx("textarea", { value: commentaire, onChange: (e) => setCommentaire(e.target.value), className: "w-full px-3 py-2 border border-gray-300 focus:ring-2 focus:ring-primary focus:border-transparent resize-none", rows: 4, placeholder: "Commentaires optionnels sur la pr\u00E9-lecture..." })] }), _jsxs("div", { className: "flex justify-end gap-3", children: [_jsx(Button, { variant: "outline", onClick: () => setShowValidationModal(false), children: "Annuler" }), _jsx(Button, { onClick: handleConfirmValidation, className: "bg-primary hover:bg-primary-700", children: "Valider" })] })] }) }) })), showRejetModal && (_jsx(AnimatePresence, { children: _jsx(motion.div, { initial: { opacity: 0 }, animate: { opacity: 1 }, exit: { opacity: 0 }, className: "fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[60] p-4 overflow-y-auto", onClick: () => setShowRejetModal(false), children: _jsxs(motion.div, { initial: { scale: 0.95, opacity: 0 }, animate: { scale: 1, opacity: 1 }, exit: { scale: 0.95, opacity: 0 }, onClick: (e) => e.stopPropagation(), className: "bg-white max-w-2xl w-full my-8 p-6", children: [_jsx("h3", { className: "text-lg font-semibold text-gray-900 mb-4", children: "Rejeter la pr\u00E9-lecture" }), _jsxs("div", { className: "space-y-4", children: [_jsxs("div", { children: [_jsx("label", { className: "block text-sm font-medium text-gray-700 mb-1", children: "Commentaire de rejet (obligatoire) *" }), _jsx("textarea", { value: rejetCommentaire, onChange: (e) => setRejetCommentaire(e.target.value), className: "w-full px-3 py-2 border border-gray-300 focus:ring-2 focus:ring-primary focus:border-transparent resize-none", rows: 4, placeholder: "Indiquez les raisons du rejet...", required: true })] }), _jsxs("div", { children: [_jsx("label", { className: "block text-sm font-medium text-gray-700 mb-2", children: "Corrections \u00E0 apporter (optionnel)" }), _jsxs("div", { className: "space-y-2", children: [corrections.map((correction, index) => (_jsxs("div", { className: "flex gap-2", children: [_jsx("input", { type: "text", value: correction, onChange: (e) => handleCorrectionChange(index, e.target.value), className: "flex-1 px-3 py-2 border border-gray-300 focus:ring-2 focus:ring-primary focus:border-transparent", placeholder: `Correction ${index + 1}...` }), corrections.length > 1 && (_jsx(Button, { variant: "outline", size: "sm", onClick: () => handleRemoveCorrection(index), className: "text-red-600 hover:text-red-700", children: _jsx(X, { className: "h-4 w-4" }) }))] }, index))), _jsx(Button, { variant: "outline", size: "sm", onClick: handleAddCorrection, className: "w-full", children: "+ Ajouter une correction" })] }), _jsx("p", { className: "text-xs text-gray-500 mt-2", children: "Ces corrections seront transmises \u00E0 l'encadrant principal qui pourra cr\u00E9er des t\u00E2ches sp\u00E9cifiques pour l'\u00E9tudiant." })] })] }), _jsxs("div", { className: "flex justify-end gap-3 mt-6", children: [_jsx(Button, { variant: "outline", onClick: () => setShowRejetModal(false), children: "Annuler" }), _jsx(Button, { onClick: handleConfirmRejet, disabled: !rejetCommentaire.trim(), className: "bg-gray-600 hover:bg-gray-700 disabled:opacity-50 disabled:cursor-not-allowed", children: "Rejeter" })] })] }) }) })), selectedDocument && (_jsx(AnimatePresence, { children: _jsx(motion.div, { initial: { opacity: 0 }, animate: { opacity: 1 }, exit: { opacity: 0 }, className: "fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[70] p-4", onClick: () => setSelectedDocument(null), children: _jsxs(motion.div, { initial: { scale: 0.95, opacity: 0 }, animate: { scale: 1, opacity: 1 }, exit: { scale: 0.95, opacity: 0 }, onClick: (e) => e.stopPropagation(), className: "bg-white max-w-4xl w-full h-[90vh] flex flex-col", children: [_jsxs("div", { className: "border-b border-gray-200 px-6 py-4 flex justify-between items-start", children: [_jsxs("div", { className: "flex-1", children: [_jsx("h3", { className: "text-lg font-semibold text-gray-900 mb-2", children: selectedDocument.titreMemoire }), _jsxs("div", { className: "flex items-center gap-4 text-sm text-gray-600", children: [_jsxs("span", { children: [selectedDocument.auteur.prenom, " ", selectedDocument.auteur.nom] }), _jsx("span", { children: "\u2022" }), _jsx("span", { children: selectedDocument.anneeAcademique }), _jsx("span", { children: "\u2022" }), _jsx("span", { children: selectedDocument.departement })] }), selectedDocument.encadrant && (_jsxs("p", { className: "text-sm text-gray-600 mt-1", children: ["Encadrant : ", selectedDocument.encadrant.prenom, " ", selectedDocument.encadrant.nom] })), _jsx("div", { className: "mt-2", children: _jsxs(Badge, { className: "bg-blue-50 text-blue-700 border-blue-200", children: [selectedDocument.similarityScore, "% de similarit\u00E9 d\u00E9tect\u00E9e"] }) })] }), _jsx("button", { onClick: () => setSelectedDocument(null), className: "text-gray-400 hover:text-gray-600 transition-colors ml-4", children: _jsx(X, { className: "h-5 w-5" }) })] }), _jsx("div", { className: "flex-1 overflow-hidden bg-gray-100 p-6", children: _jsxs("div", { className: "bg-white h-full flex flex-col items-center justify-center border-2 border-dashed border-gray-300", children: [_jsx(FileText, { className: "h-16 w-16 text-gray-400 mb-4" }), _jsx("p", { className: "text-gray-900 font-medium mb-2", children: "Pr\u00E9visualisation du document" }), _jsxs("p", { className: "text-sm text-gray-600 mb-4 text-center max-w-md", children: ["Le document ", _jsx("span", { className: "font-medium", children: selectedDocument.nomFichier }), " (", selectedDocument.taille, ") est disponible pour consultation."] }), _jsx("p", { className: "text-xs text-gray-500 mb-6", children: "Dans un environnement de production, le visualiseur PDF serait int\u00E9gr\u00E9 ici." }), _jsxs("div", { className: "flex gap-3", children: [_jsxs(Button, { onClick: () => {
                                                        // Simulation du téléchargement
                                                        alert(`Téléchargement de ${selectedDocument.nomFichier}...\n\nDans un environnement de production, le fichier serait téléchargé depuis:\n${selectedDocument.cheminFichier}`);
                                                    }, className: "flex items-center gap-2 bg-primary hover:bg-primary-700", children: [_jsx(Download, { className: "h-4 w-4" }), "T\u00E9l\u00E9charger le document"] }), _jsx(Button, { variant: "outline", onClick: () => setSelectedDocument(null), children: "Fermer" })] })] }) })] }) }) }))] }));
};
